<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perpustakaan Digital</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        header { background-color: #333; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .search-bar { flex: 1; margin: 0 20px; }
        .search-bar input { width: 100%; padding: 8px; border: none; border-radius: 4px; }
        .auth-menu { display: flex; gap: 10px; align-items: center; }
        .auth-menu button { background: #555; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .auth-menu button:hover { background: #777; }
        .auth-menu button:disabled { background: #999; cursor: not-allowed; }
        #userInfo { margin-right: 10px; }
        .main { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .book-card { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: transform 0.2s; }
        .book-card:hover { transform: scale(1.02); }
        .book-card img { width: 100%; height: 250px; object-fit: cover; border-radius: 4px; }
        .book-card h3 { margin: 10px 0; }
        .book-card p { color: #666; font-size: 14px; }
        .action-btn { background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin: 2px; }
        .action-btn:hover { background: #45a049; }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; }
        .return-btn { background: #f44336; }
        .return-btn:hover { background: #da190b; }
        .admin-panel { display: none; background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .admin-panel form { display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .admin-panel input, .admin-panel textarea, .admin-panel select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .admin-panel button { background: #2196F3; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
        .admin-panel button:hover { background: #0b7dda; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .login-form, .register-form { display: none; position: fixed; z-index: 1001; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .login-form form, .register-form form { display: flex; flex-direction: column; gap: 10px; }
        .login-form input, .register-form input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .login-form button, .register-form button { background: #4CAF50; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
        .login-form button:hover, .register-form button:hover { background: #45a049; }
        .hidden { display: none; }
        #bookListAdmin div { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <header>
        <h1>Perpustakaan Digital</h1>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Cari buku berdasarkan judul atau penulis...">
        </div>
        <div class="auth-menu" id="authMenu">
            <span id="userInfo" class="hidden"></span>
            <button id="loginBtn" onclick="showLogin()">Login</button>
            <button id="registerBtn" onclick="showRegister()">Register</button>
            <button id="logoutBtn" class="hidden" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="login-form" id="loginForm">
        <form onsubmit="login(event)">
            <h2>Login</h2>
            <input type="text" id="loginUsername" placeholder="Username" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button type="submit">Login</button>
            <button type="button" onclick="hideLogin()">Batal</button>
        </form>
    </div>

    <div class="register-form" id="registerForm">
        <form onsubmit="register(event)">
            <h2>Register</h2>
            <input type="text" id="regUsername" placeholder="Username" required>
            <input type="password" id="regPassword" placeholder="Password" required>
            <button type="submit">Register</button>
            <button type="button" onclick="hideRegister()">Batal</button>
        </form>
    </div>

    <div class="main">
        <div id="adminPanel" class="admin-panel">
            <h2>Panel Admin: Kelola Buku</h2>
            <form onsubmit="addBook(event)">
                <input type="text" id="bookTitle" placeholder="Judul Buku" required>
                <input type="text" id="bookAuthor" placeholder="Penulis" required>
                <input type="number" id="bookStock" placeholder="Stok Awal" min="0" required>
                <input type="url" id="bookCover" placeholder="URL Gambar Sampul (contoh: https://images.unsplash.com/...)" required>
                <textarea id="bookDesc" placeholder="Deskripsi Buku" rows="3"></textarea>
                <button type="submit">Tambah Buku</button>
            </form>
            <h3>Daftar Buku (Edit/Hapus)</h3>
            <div id="bookListAdmin"></div>
        </div>

        <h2>Daftar Buku</h2>
        <div id="bookGrid" class="book-grid"></div>
    </div>

    <!-- Modal Detail Buku -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Data simulasi database (buku dan user) - PERBAIKAN: Hapus spasi ekstra di key localStorage
        let books = JSON.parse(localStorage.getItem('books')) || [
            { id: 1, title: 'Harry Potter', author: 'J.K. Rowling', stock: 5, cover: 'https://images.unsplash.com/photo-1512820790803-83ca3b5e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&h=250&q=80', desc: 'Petualangan si penyihir muda.' },
            { id: 2, title: 'The Lord of the Rings', author: 'J.R.R. Tolkien', stock: 3, cover: 'https://images.unsplash.com/photo-1532012197267-da84d127e765?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&h=250&q=80', desc: 'Epik fantasi tentang cincin.' },
            { id: 3, title: 'To Kill a Mockingbird', author: 'Harper Lee', stock: 2, cover: 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&h=250&q=80', desc: 'Cerita tentang keadilan dan prasangka.' }
        ];
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let currentUser  = JSON.parse(localStorage.getItem('currentUser ')) || null;  // PERBAIKAN: Hapus spasi di key dan variabel
        const ADMIN_USER = { username: 'admin', password: 'admin123', role: 'admin' };

        // Inisialisasi - PERBAIKAN: Update menu berdasarkan currentUser 
        function initApp() {
            if (currentUser ) {
                document.getElementById('userInfo').textContent = `Selamat datang, ${currentUser .username}! (Role: ${currentUser .role || 'user'})`;
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('registerBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                if (currentUser .role === 'admin') {
                    document.getElementById('adminPanel').style.display = 'block';
                    loadAdminBooks();
                }
            } else {
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('registerBtn').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
            }
            renderBooks();
        }
        initApp();

        // Search functionality - PERBAIKAN: Lebih smooth
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredBooks = books.filter(book => 
                book.title.toLowerCase().includes(query) || book.author.toLowerCase().includes(query)
            );
            renderBooks(filteredBooks);
        });

        // Render buku - PERBAIKAN: Cegah konflik onclick pada tombol
        function renderBooks(booksToRender = books) {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = '';
            booksToRender.forEach(book => {
                const card = document.createElement('div');
                card.className = 'book-card';
                let actions = '';
                if (currentUser ) {
                    if (currentUser .role === 'admin') {
                        actions = `
                            <button class="action-btn" onclick="editBook(${book.id}); event.stopPropagation();">Edit</button>
                            <button class="action-btn" style="background:#ff9800;" onclick="deleteBook(${book.id}); event.stopPropagation();">Hapus</button>
                        `;
                    } else {
                        actions = `
                            <button class="action-btn" onclick="borrowBook(${book.id}); event.stopPropagation();" ${book.stock <= 0 ? 'disabled' : ''}>Pinjam</button>
                            <button class="return-btn action-btn" onclick="returnBook(${book.id}); event.stopPropagation();">Kembalikan</button>
                        `;
                    }
                }
                card.innerHTML = `
                    <img src="${book.cover}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/200x250?text=No+Image'">
                    <h3>${book.title}</h3>
                    <p>Penulis: ${book.author}</p>
                    <p>Stok: ${book.stock}</p>
                    ${actions}
                `;
                card.addEventListener('click', (e) => { 
                    if (!e.target.closest('button')) showBookDetail(book); 
                });
                grid.appendChild(card);
            });
        }

        // Show detail buku di modal
        function showBookDetail(book) {
            document.getElementById('modalBody').innerHTML = `
                <img src="${book.cover}" alt="${book.title}" style="width:100%; max-height:300px; object-fit:cover; border-radius:4px;">
                <h2>${book.title}</h2>
                <p><strong>Penulis:</strong> ${book.author}</p>
                <p><strong>Stok Tersedia:</strong> ${book.stock}</p>
                <p><strong>Deskripsi:</strong> ${book.desc || 'Tidak ada deskripsi.'}</p>
                ${currentUser  && currentUser .role !== 'admin' ? `
                    <p><strong>Status Pinjam:</strong> ${book.stock > 0 ? 'Tersedia' : 'Sedang Dipinjam'}</p>
                    <button class="action-btn" onclick="borrowBook(${book.id}); closeModal(); event.stopPropagation();">Pinjam Buku Ini</button>
                    <button class="return-btn action-btn" onclick="returnBook(${book.id}); closeModal(); event.stopPropagation();">Kembalikan Buku Ini</button>
                ` : ''}
            `;
            document.getElementById('bookModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('bookModal').style.display = 'none';
        }

        // PERBAIKAN: Form login/register sebagai modal fixed, lebih mudah ditekan
        function showLogin() { 
            document.getElementById('loginForm').style.display = 'block'; 
            document.getElementById('loginUsername').focus();
        }
        function hideLogin() { document.getElementById('loginForm').style.display = 'none'; }
        function showRegister() { 
            document.getElementById('registerForm').style.display = 'block'; 
            document.getElementById('regUsername').focus();
        }
        function hideRegister() { document.getElementById('registerForm').style.display = 'none'; }

        // Login - PERBAIKAN: Update menu setelah login
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            let user = users.find(u => u.username === username && u.password === password);
            if (!user && username === ADMIN_USER.username && password === ADMIN_USER.password) {
                user = ADMIN_USER;
                // Tambah admin ke users jika belum ada
                if (!users.find(u => u.username === 'admin')) users.push(ADMIN_USER);
                localStorage.setItem('users', JSON.stringify(users));
            }
            if (user) {
                currentUser  = user;
                localStorage.setItem('currentUser ', JSON.stringify(currentUser ));  // PERBAIKAN: Key tanpa spasi
                initApp();  // Reload menu
                hideLogin();
                renderBooks();
                if (user.role === 'admin') loadAdminBooks();
                alert('Login berhasil!');
            } else {
                alert('Username atau password salah! Coba admin / admin123 untuk admin.');
            }
        }

        // Register
        function register(event) {
            event.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            if (users.find(u => u.username === username)) {
                alert('Username sudah ada!');
                return;
            }
            const newUser  = { username, password, role: 'user' };
            users.push(newUser );
            localStorage.setItem('users', JSON.stringify(users));
            alert('Registrasi berhasil! Silakan login.');
            hideRegister();
        }

        // Logout - PERBAIKAN: Reset semuanya
        function logout() {
            currentUser  = null;
            localStorage.removeItem('currentUser ');  // PERBAIKAN: Key tanpa spasi
            initApp();
        }